{% extends "base.html" %}

{% block title %}Results - {{ query }} - Web Scraper{% endblock %}

{% block extra_styles %}
<style>
    .results-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e0e0e0;
    }
    
    .results-info h2 {
        color: #1a237e;
        margin-bottom: 5px;
    }
    
    .results-info p {
        color: #666;
    }
    
    .export-buttons {
        display: flex;
        gap: 10px;
    }
    
    .product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .product-card {
        background: #fff;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        transition: all 0.3s;
        position: relative;
    }
    
    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        border-color: #667eea;
    }
    
    .product-card.selected {
        border-color: #4caf50;
        background: #f1f8f4;
    }
    
    .product-checkbox {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 20px;
        height: 20px;
        cursor: pointer;
    }
    
    .product-name {
        font-size: 16px;
        font-weight: 600;
        color: #333;
        margin-bottom: 10px;
        padding-right: 30px;
        line-height: 1.4;
    }
    
    .product-price {
        font-size: 24px;
        font-weight: bold;
        color: #1a237e;
        margin: 10px 0;
    }
    
    .product-original-price {
        text-decoration: line-through;
        color: #999;
        font-size: 16px;
        margin-right: 10px;
    }
    
    .product-discount {
        background: #4caf50;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
    }
    
    .product-rating {
        display: inline-block;
        background: #ff9800;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 14px;
        margin: 10px 0;
    }
    
    .product-info {
        color: #666;
        font-size: 14px;
        margin: 5px 0;
    }
    
    .product-seller {
        background: #f5f5f5;
        padding: 8px;
        border-radius: 4px;
        margin-top: 10px;
        font-size: 14px;
    }
    
    .product-availability {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
    }
    
    .in-stock {
        background: #e8f5e9;
        color: #2e7d32;
    }
    
    .limited-stock {
        background: #fff3e0;
        color: #ef6c00;
    }
    
    .out-of-stock {
        background: #ffebee;
        color: #c62828;
    }
    
    .selection-toolbar {
        background: #f5f5f5;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .selection-info {
        font-weight: 600;
        color: #333;
    }
    
    .selection-actions {
        display: flex;
        gap: 10px;
    }
    
    .back-link {
        display: inline-block;
        margin-top: 20px;
        color: #667eea;
        text-decoration: none;
        font-weight: 600;
    }
    
    .back-link:hover {
        text-decoration: underline;
    }
</style>
{% endblock %}

{% block content %}
<div class="results-header">
    <div class="results-info">
        <h2>Search Results for "{{ query }}"</h2>
        <p>Found {{ total }} products</p>
    </div>
    <div class="export-buttons">
        <form action="/export/csv" method="POST" style="display: inline;">
            <input type="hidden" name="export-all" value="1" id="csv-export-all">
            <button type="submit" class="btn btn-success" onclick="gatherSelected('csv')">
                üìä Export CSV
            </button>
        </form>
        <form action="/export/pdf" method="POST" style="display: inline;">
            <input type="hidden" name="export-all" value="1" id="pdf-export-all">
            <button type="submit" class="btn btn-danger" onclick="gatherSelected('pdf')">
                üìÑ Export PDF
            </button>
        </form>
    </div>
</div>

<div class="selection-toolbar">
    <div class="selection-info">
        <span id="selection-count">0</span> products selected
    </div>
    <div class="selection-actions">
        <button onclick="selectAll()" class="btn btn-secondary">Select All</button>
        <button onclick="deselectAll()" class="btn btn-secondary">Deselect All</button>
    </div>
</div>

<div class="product-grid" id="product-grid">
    {% for product in results %}
    <div class="product-card" id="card-{{ loop.index0 }}">
        <input type="checkbox" class="product-checkbox" data-index="{{ loop.index0 }}" 
               onchange="toggleSelection(this)">
        
        <div class="product-name">{{ product.product_name }}</div>
        
        <div class="product-price">
            ‚Çπ{{ "%.2f"|format(product.price) }}
            {% if product.discount_percentage > 0 %}
                <span class="product-original-price">‚Çπ{{ "%.2f"|format(product.original_price) }}</span>
                <span class="product-discount">-{{ product.discount_percentage }}%</span>
            {% endif %}
        </div>
        
        {% if product.rating %}
        <div class="product-rating">
            ‚≠ê {{ product.rating }}/5.0
        </div>
        {% endif %}
        
        <div class="product-info">
            {% if product.reviews_count %}
                {{ product.reviews_count }} reviews
            {% endif %}
        </div>
        
        <div class="product-seller">
            üè™ {{ product.seller }}
        </div>
        
        <div style="margin-top: 10px;">
            <span class="product-availability {% if product.availability == 'In Stock' %}in-stock{% elif product.availability == 'Limited Stock' %}limited-stock{% else %}out-of-stock{% endif %}">
                {{ product.availability }}
            </span>
        </div>
    </div>
    {% endfor %}
</div>

<a href="/" class="back-link">‚Üê Back to Search</a>

<script>
    let selectedIndices = new Set();
    
    function toggleSelection(checkbox) {
        const index = parseInt(checkbox.dataset.index);
        const card = document.getElementById('card-' + index);
        
        if (checkbox.checked) {
            selectedIndices.add(index);
            card.classList.add('selected');
        } else {
            selectedIndices.delete(index);
            card.classList.remove('selected');
        }
        
        updateSelectionCount();
    }
    
    function updateSelectionCount() {
        document.getElementById('selection-count').textContent = selectedIndices.size;
    }
    
    function selectAll() {
        const checkboxes = document.querySelectorAll('.product-checkbox');
        checkboxes.forEach(cb => {
            if (!cb.checked) {
                cb.checked = true;
                toggleSelection(cb);
            }
        });
    }
    
    function deselectAll() {
        const checkboxes = document.querySelectorAll('.product-checkbox');
        checkboxes.forEach(cb => {
            if (cb.checked) {
                cb.checked = false;
                toggleSelection(cb);
            }
        });
    }
    
    function gatherSelected(format) {
        const form = format === 'csv' ? 
            document.querySelector('form[action="/export/csv"]') :
            document.querySelector('form[action="/export/pdf"]');
        
        // Remove existing hidden inputs
        form.querySelectorAll('input[name="selected"]').forEach(el => el.remove());
        
        // Add selected indices
        if (selectedIndices.size > 0) {
            selectedIndices.forEach(index => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'selected';
                input.value = index;
                form.appendChild(input);
            });
        }
        
        return true;
    }
</script>
{% endblock %}
